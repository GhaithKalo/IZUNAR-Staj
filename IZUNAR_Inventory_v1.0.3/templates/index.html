{% extends "base.html" %}
{% block title %}Izu Nar Lab Malzemeleri{% endblock %}

{% block content %}
<h3 class="mb-4">IzuNar Lab Malzemeleri</h3>

<div class="mb-4 d-flex align-items-center gap-2 flex-wrap">
  {% if current_user.has_add_permission() %}
    <a href="{{ url_for('add_component') }}" class="btn btn-primary btn-sm rounded">
      <i class="bi bi-plus-circle me-1"></i> Ürün Ekle
    </a>
  {% endif %}
</div>

<form method="get" action="{{ url_for('index') }}" class="mb-3">
  <div class="input-group">
    <input
      type="search"
      name="q"
      class="form-control"
      placeholder="Ürün adı, türü veya koduna göre ara..."
      value="{{ request.args.get('q', '') }}"
      aria-label="Ara"
      autocomplete="off"
    >
    <button class="btn btn-outline-primary" type="submit">
      <i class="bi bi-search"></i> Ara
    </button>
  </div>
</form>

{# --- Arama Sonucu --- #}
{% if search_query %}
  <h4>“{{ search_query }}” için arama sonuçları</h4>
  {% for type, comps in grouped_components.items() %}
    <h5 class="mt-4">{{ type }}</h5>
    <div class="row g-4 products-container">
      {% for comp in comps %}
        {% set component = comp %}
        {% include 'partials/product_card.html' %}
      {% endfor %}
    </div>
  {% endfor %}

{# --- Kategori Yoksa: Kategori Listesi --- #}
{% elif not selected_category %}
  <h4>Kategoriler</h4>
  <ul class="list-unstyled d-flex flex-wrap gap-2">
    {% for cat in all_categories %}
      <li>
        <a href="{{ url_for('index', category=cat) }}" class="btn btn-outline-primary">
          {{ cat.capitalize() }}
        </a>
      </li>
    {% endfor %}
  </ul>

{# --- Kategori Seçiliyse Ama Tür Seçilmediyse --- #}
{% elif selected_category and grouped_components %}
  <h4>{{ selected_category.capitalize() }} Kategorisindeki Ürün Türleri</h4>
  <ul class="list-unstyled d-flex flex-wrap gap-2">
    {% for type in all_types %}
      <li>
        <button
          class="btn btn-outline-secondary"
          onclick="toggleProducts('{{ type|replace(' ', '_') }}')"
          aria-expanded="false"
          aria-controls="products-{{ type|replace(' ', '_') }}"
        >
          {{ type }}
        </button>
      </li>
    {% endfor %}
  </ul>
{% endif %}

{# --- Ürün Kartları --- #}
{% for type, comps in grouped_components.items() %}
  <div id="products-{{ type|replace(' ', '_') }}"
       class="row g-4 products-container {% if not search_query %}d-none{% endif %}"
       style="margin-top: 1rem;">
    {% for comp in comps %}
      {% set component = comp %}
      {% include 'partials/product_card.html' %}
    {% endfor %}
  </div>
{% endfor %}
{% endblock %}

{# --- Stil ve Script Partials --- #}
{% block styles %}
  {% include 'partials/index_styles.html' %}
{% endblock %}

{% block scripts %}
  {% include 'partials/index_scripts.html' %}
{% endblock %}

