{% extends 'base.html' %}
{% block title %}{{ component.name }} ({{ component.code or 'Kodsuz' }}) - Bileşen Detayı{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="card shadow-sm p-4 border-0 rounded-3" style="background-color: #f9f9f9;">
        <div class="row g-4">
            <div class="col-md-4 text-center">
                <img src="{{ component.image_url or 'https://via.placeholder.com/300' }}" 
                     class="img-fluid rounded shadow-sm" alt="{{ component.name }}">
            </div>
            <div class="col-md-8">
                <h2 class="fw-bold text-primary">{{ component.name }}</h2>

                <p><strong>Kod:</strong> {{ component.code or 'Belirtilmemiş' }}</p>

                <p>
                  <strong>Ürün Tipi:</strong>
                  {% if component.category == 'demirbas' %}
                    <span class="badge bg-primary">Demirbaş</span>
                  {% elif component.category == 'sarf' %}
                    <span class="badge bg-secondary">Sarf</span>
                  {% else %}
                    <span class="badge bg-light text-dark">Belirtilmemiş</span>
                  {% endif %}
                </p>

                <p><strong>Tür:</strong> {{ component.type }}</p>

                {% if component.tags %}
                  <p><strong>Etiketler:</strong> 
                    {% for tag in component.tags %}
                      <span class="badge bg-info text-dark me-1">{{ tag.name }}</span>
                    {% endfor %}
                  </p>
                {% endif %}

                <p><strong>Konum:</strong> {{ component.location }}</p>
                <p><strong>Açıklama:</strong> {{ component.description }}</p>
                <p>Stok: <strong class="text-success">{{ component.quantity }}</strong></p>
                <p><strong>Parça Numarası:</strong> {{ component.part_number or '-' }}</p>

                {% if current_user.role == 'admin' %}
                <form method="POST" action="{{ url_for('update_stock', comp_id=component.id) }}" 
                      class="d-inline-flex align-items-center gap-2 mt-3 flex-wrap">
                    <input type="hidden" id="action-input" name="action" value="">
                    <input type="number" name="amount" id="amount-input" value="1" min="1" 
                           class="form-control form-control-sm" style="width: 80px;" required>
                    <input type="text" name="serial_number" class="form-control form-control-sm" placeholder="Seri No (demirbaş)" style="width: 160px;">
                    <input type="text" name="owner_prefix" class="form-control form-control-sm" placeholder="Kısaltma (HR, IT)" style="width: 140px;">

                    <div class="btn-group" role="group" aria-label="Stok Güncelle">
                        <button type="submit" onclick="setAction('decrease')" class="btn btn-outline-danger">
                            <i class="bi bi-dash-circle-fill"></i> Azalt
                        </button>
                        <button type="submit" onclick="setAction('increase')" class="btn btn-outline-success">
                            <i class="bi bi-plus-circle-fill"></i> Arttır
                        </button>
                    </div>
                </form>

                {% if current_user.has_delete_permission() %}
                <form method="POST" action="{{ url_for('delete_component', comp_id=component.id) }}" 
                      onsubmit="return confirmDelete('{{ component.name|escape }}');"
                      class="mt-3">
                    {% if csrf_token %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    {% endif %}
                    <button type="submit" class="btn btn-outline-danger">
                      <i class="bi bi-trash-fill me-1"></i> Ürünü Sil
                    </button>
                </form>
                {% endif %}
                {% endif %}

                <hr class="my-4">

                {% if component.category == 'demirbas' %}
                <h4 class="text-secondary fw-semibold">Seri Numaraları</h4>
                <table class="table table-sm table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Seri No</th>
                      <th>Sahip</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in inventory_items %}
                      <tr>
                        <td>{{ item.serial_number }}</td>
                        <td>{{ item.assigned_to or "Boşta" }}</td>
                      </tr>
                    {% else %}
                      <tr><td colspan="2" class="text-center">Kayıtlı seri numarası yok.</td></tr>
                    {% endfor %}
                  </tbody>
                </table>

                <h4 class="text-secondary fw-semibold mt-4">Ödünç Alma Geçmişi</h4>
                {% if borrow_history %}
                <div class="table-responsive mt-3 mb-4">
                    <table class="table table-striped table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Kullanıcı</th>
                                <th>Seri No</th>
                                <th>Ödünç Alınma</th>
                                <th>İade</th>
                                <th>Adet</th>
                                <th>Lokasyon</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in borrow_history %}
                            <tr>
                                <td>{{ record.user_name }}</td>
                                <td>{{ record.serial_number }}</td>
                                <td>{{ record.borrow_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if record.return_date %}
                                        {{ record.return_date.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        <span class="text-danger fst-italic">Henüz iade edilmedi</span>
                                    {% endif %}
                                </td>
                                <td>{{ record.amount }}</td>
                                <td>{{ record.location or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mt-3">Henüz ödünç alma geçmişi bulunmamaktadır.</p>
                {% endif %}
                {% endif %}

                {% if component.category == 'sarf' %}
                <h4 class="text-secondary fw-semibold">Sarf Etme Geçmişi</h4>
                {% if consume_history %}
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Kullanıcı</th>
                                <th>Sarf Tarihi</th>
                                <th>Miktar</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in consume_history %}
                            <tr>
                                <td>{{ record.user_name }}</td>
                                <td>{{ record.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ record.amount }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mt-3">Henüz sarf etme geçmişi bulunmamaktadır.</p>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    function setAction(action) {
        document.getElementById('action-input').value = action;
    }

    function confirmDelete(componentName) {
        return confirm(`"${componentName}" isimli ürünü silmek üzeresiniz. Bu işlem geri alınamaz. Emin misiniz?`);
    }
</script>
{% endblock %}
