{% extends "base.html" %}
{% block title %}Izu Nar Lab Malzemeleri{% endblock %}

{% block content %}
<h3 class="mb-4">IzuNar Lab Malzemeleri</h3>

<div class="mb-4 d-flex align-items-center gap-2 flex-wrap">
  {% if current_user.can_add_product %}
  <a href="{{ url_for('add_component') }}" class="btn btn-primary btn-sm rounded">
    <i class="bi bi-plus-circle me-1"></i> Ürün Ekle
  </a>
  {% endif %}

  <a href="{{ url_for('my_borrowed') }}" class="btn btn-info btn-sm">
    <i class="bi bi-box-arrow-in-down"></i> Ödünç Aldıklarım
  </a>

  <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm ms-auto">
    <i class="bi bi-box-arrow-right"></i> Çıkış Yap
  </a>
</div>

<form method="get" action="{{ url_for('index') }}" class="mb-3">
  <div class="input-group">
    <input
      type="search"
      name="q"
      class="form-control"
      placeholder="Ürün adı veya türüne göre ara..."
      value="{{ request.args.get('q', '') }}"
      aria-label="Ara"
      autocomplete="off"
    >
    <button class="btn btn-outline-primary" type="submit">
      <i class="bi bi-search"></i> Ara
    </button>
  </div>
</form>

{% set grouped = grouped_components.items() %}
{% if not search_query %}
  <h4>Ürün Türleri</h4>
  <ul>
    {% for type, _ in grouped %}
      <li style="margin-bottom: 0.5rem;">
        <button
          class="btn btn-outline-secondary btn-sm"
          onclick="toggleProducts('{{ type|replace(' ', '_') }}')"
          aria-expanded="false"
          aria-controls="products-{{ type|replace(' ', '_') }}"
          type="button"
        >
          {{ type }}
          <i class="bi bi-caret-down-fill ms-1"></i>
        </button>
      </li>
    {% endfor %}
  </ul>
{% endif %}

{% for type, comps in grouped %}
  <div id="products-{{ type|replace(' ', '_') }}"
       class="row g-4 products-container {% if not search_query %}d-none{% endif %}"
       style="margin-top: 1rem;">
    {% for comp in comps %}
    <div class="col-12 col-md-6 col-lg-3 d-flex">
      <div class="card shadow-sm h-100 d-flex flex-column" style="border-radius: 12px;">
        <a href="{{ url_for('component_detail', comp_id=comp.id) }}" class="text-decoration-none text-dark flex-grow-1 d-flex flex-column">
          <div class="card-body d-flex flex-column">
            <div class="text-center mb-3">
              <img src="{{ comp.image_url }}" alt="{{ comp.name }}" class="img-fluid rounded" style="max-height: 180px; object-fit: contain;">
            </div>

            <h5 class="card-title text-center mb-2">{{ comp.name }}</h5>

            <div class="text-muted small text-center mb-3">
              Konum: <strong>{{ comp.location or 'Bilinmiyor' }}</strong><br>
              Stok: <strong class="text-success">{{ comp.quantity }}</strong>
            </div>
          </div>
        </a>

        <div class="card-footer d-flex flex-wrap justify-content-center align-items-center gap-2">
          <!-- Ödünç Al -->
          <form action="{{ url_for('borrow', comp_id=comp.id) }}" method="post" class="d-flex justify-content-center align-items-center gap-2 borrow-form mb-2 mb-sm-0" style="min-width: 130px; max-width: 180px; flex-shrink: 1;">
            {% if csrf_token %}
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% endif %}
            <div class="input-group input-group-sm amount-input-group" style="width: 110px !important;">
              <button type="button" class="btn btn-outline-secondary amount-btn" onclick="adjustAmount(this, -1)">−</button>
              <input id="amount-{{ comp.id }}" type="number" name="amount" value="1" min="1" max="{{ comp.quantity }}" class="form-control amount-input text-center" required>
              <button type="button" class="btn btn-outline-secondary amount-btn" onclick="adjustAmount(this, 1)">+</button>
            </div>
            <button type="submit" class="btn btn-success btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Ödünç Al</button>
          </form>

          <!-- Sarf Et -->
          <form method="POST" action="{{ url_for('consume_component', comp_id=comp.id) }}" class="d-inline-block me-2" style="min-width: 60px; max-width: 90px; flex-shrink: 1;" onsubmit="return confirmConsume(event, {{ comp.id }}, '{{ comp.name }}');">
            {% if csrf_token %}
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% endif %}
            <input type="hidden" name="amount" id="consume-amount-{{ comp.id }}" value="1">
            <button type="submit" class="btn btn-danger btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Sarf Et</button>
          </form>

          <!-- Admin Sil -->
          {% if current_user.role == 'admin' %}
          <form method="POST" action="{{ url_for('delete_component', comp_id=comp.id) }}" class="d-inline-block" style="min-width: 60px; max-width: 90px; flex-shrink: 1;" onsubmit="return confirm('Bu ürünü silmek istediğinize emin misiniz?');">
            {% if csrf_token %}
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% endif %}
            <button type="submit" class="btn btn-sm btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Sil</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
{% endfor %}

<style>
  /* Ürün kartları küçültme */
  .product-card {
    padding: 0.75rem;
    font-size: 0.9rem;
    background-color: #fff;
    transition: box-shadow 0.2s ease, transform 0.2s ease;
  }
  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  /* Responsive ayarlar */
  @media (max-width: 992px) {
    .col-md-6 {
      max-width: 50% !important;
    }
    .col-md-12, .col-12 {
      max-width: 100% !important;
    }
  }

  /* Navbar hover ile gösterme */
  #navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 50px;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transform: translateY(-100%);
    transition: transform 0.3s ease;
    z-index: 1030;
  }
  #navbar:hover {
    transform: translateY(0);
  }

  /* Footer taşmasını engelleme */
  footer {
    padding: 1rem;
    text-align: center;
    font-size: 0.85rem;
    white-space: normal;
    word-wrap: break-word;
    max-width: 100%;
    box-sizing: border-box;
  }

  /* Mobil için borrow-form input ve button tam genişlik */
  @media (max-width: 576px) {
    .borrow-form {
      flex-direction: column !important;
      gap: 0.5rem;
    }

    .borrow-form input,
    .borrow-form button {
      width: 100% !important;
    }

    .product-card {
      padding: 0.75rem;
    }

    .product-card img {
      max-height: 140px !important;
    }
  }

  /* Sayaç input grubu ve butonları küçültme */
  .amount-input-group {
    width: 110px !important;
  }
  .amount-btn {
    padding: 0 5px;
    font-size: 0.85rem;
  }
  .amount-input {
    font-size: 0.85rem;
    padding: 0 4px;
  }

  /* Formlar taşmasın diye flex-shrink */
  .borrow-form,
  form.d-inline-block {
    flex-shrink: 1;
    min-width: auto;
  }

  .d-none {
    display: none !important;
  }
</style>

<script>
  function toggleProducts(typeId) {
    const allContainers = document.querySelectorAll('.products-container');
    allContainers.forEach(container => {
      if (container.id === 'products-' + typeId) {
        container.classList.toggle('d-none');
      } else {
        container.classList.add('d-none');
      }
    });

    const buttons = document.querySelectorAll('button[aria-controls^="products-"]');
    buttons.forEach(button => {
      const isTarget = button.getAttribute('aria-controls') === 'products-' + typeId;
      button.setAttribute('aria-expanded', isTarget && button.getAttribute('aria-expanded') !== 'true');
    });
  }

  function adjustAmount(button, change) {
    const input = button.parentElement.querySelector('input[type="number"]');
    let current = parseInt(input.value);
    const min = parseInt(input.min);
    const max = parseInt(input.max);
    current += change;
    if (current < min) current = min;
    if (current > max) current = max;
    input.value = current;

    // Sarf Et alanını da güncelle
    const compId = input.id.split('-')[1];
    const consumeInput = document.getElementById('consume-amount-' + compId);
    if (consumeInput) {
      consumeInput.value = input.value;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('input', () => {
        const compId = input.id.split('-')[1];
        const consumeInput = document.getElementById('consume-amount-' + compId);
        if (consumeInput) {
          consumeInput.value = input.value;
        }
      });
    });
  });

  function confirmConsume(event, compId, compName) {
    const amountInput = document.getElementById('amount-' + compId);
    const amount = amountInput ? amountInput.value : 'belirtilmemiş';
    return confirm(`${compName} ürününden ${amount} adet sarf etmek üzeresiniz. Emin misiniz?`);
  }

  const searchForm = document.querySelector('form[action="{{ url_for("index") }}"]');
  if (searchForm) {
    searchForm.addEventListener('submit', function(e) {
      const input = this.querySelector('input[name="q"]');
      if (input && input.value.trim() === '') {
        e.preventDefault();
        window.location.href = "{{ url_for('index') }}";
      }
    });
  }
</script>
{% endblock %}

